{% extends 'base/base.html' %}
{% block title %}FlowCraft{% endblock %}
{% block styles %}<link rel="stylesheet" href="/static/css/pages/index.css">{% endblock %}
{% block main_content_class %}{% endblock %}
{% block content %}
            <!-- start button in top left -->
            <div class="start_button_container" id="start_button_container" style="display: none;">
                <div class="run_controls_group">
                    <div class="loading_wheel" id="execution_loading_wheel" style="display: none;"></div>
                    <button class="btn btn_primary" id="execute_start_btn">
                        <span class="material-icons">play_arrow</span>
                        Start
                    </button>
                    <button class="btn btn_secondary" id="execute_clear_btn" title="clear">
                        <span class="material-icons">brush</span>
                        Clear
                    </button>
                </div>
            </div>

            <!-- separate right sidebar toggle bar -->
            <div class="sidebar_toggle_container" id="sidebar_toggle_container" style="display: none;">
                <button class="btn btn_secondary" id="toggle_sidebar_btn" title="hide properties" data-action="toggle-sidebar">
                    <span class="material-icons">chevron_right</span>
                </button>
            </div>
            
            <!-- floating toolbars -->
            <div class="left_toolbars" id="left_toolbars">
                <div class="floating_toolbar" id="floating_toolbar">
                    <button class="toolbar_btn" id="group_select_btn" title="group select tool">
                        <span class="material-icons">select_all</span>
                    </button>
                    <button class="toolbar_btn" id="deselect_btn" title="deselect all">
                        <span class="material-icons">pan_tool</span>
                    </button>
                    <button class="toolbar_btn" id="reset_view_btn" title="reset view to first node">
                        <span class="material-icons">center_focus_strong</span>
                    </button>
                        <button class="toolbar_btn" id="track_toggle_btn" title="auto track active node">
                            <span class="material-icons">gps_fixed</span>
                        </button>
                </div>
                <div class="floating_toolbar_secondary" id="floating_toolbar_secondary">
                    <button class="toolbar_btn" id="error_toggle_btn" title="show error circles">
                        <span class="material-icons">priority_high</span>
                    </button>
                    <button class="toolbar_btn" id="flow_toggle_btn" title="show flow circles">
                        <span class="material-icons">device_hub</span>
                    </button>
                </div>
            </div>
            
            <!-- top toolbars container (build mode only content) -->
            <div class="top_toolbars" id="top_toolbars">
                <!-- annotation toolbar (icon-only) -->
                <div class="annotation_toolbar" id="annotation_toolbar" style="display:none;">
                    <button class="btn btn_secondary toolbar_icon_btn" id="add_text_btn" title="add text">
                        <span class="material-icons">title</span>
                    </button>
                    <button class="btn btn_secondary toolbar_icon_btn" id="add_arrow_btn" title="add arrow">
                        <span class="material-icons">arrow_forward</span>
                    </button>
                </div>

                <!-- build mode horizontal toolbar -->
            <div class="build_toolbar" id="build_toolbar" style="display:none;">
                    <div class="build_toolbar_items" id="build_toolbar_items">
                        <div style="width: 0px; height: 8px;"></div>
                        <button class="btn btn_secondary" id="python_node_btn" title="add python node">
                            <span class="material-icons">code</span>
                            Python
                        </button>
                        <button class="btn btn_secondary" id="if_condition_btn" title="add if condition">
                            <span class="material-icons">alt_route</span>
                            IF Condition
                        </button>
                        <button class="btn btn_secondary" id="ai_btn" title="ai">
                            <span class="material-icons">smart_toy</span>
                            AI
                        </button>
                    </div>
                    <button class="btn btn_primary build_toolbar_toggle" id="build_toolbar_toggle" title="add" data-action="toggle-build-toolbar">
                        <span class="material-icons">add</span>
                    </button>
                </div>
            </div>
            
            <div class="canvas_container">
                <svg id="flowchart_canvas">
                    <g id="zoom_group">
                        <!-- Placeholder for node order numbers -->
                        <text class="node_order" x="0" y="0" visibility="hidden">0</text>
                    </g>
                </svg>
            </div>

            {% include 'partials/run_feed.html' %}
        </div>
{% block scripts %}
    <!-- d3 for builder canvas -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- core modules -->
    <script src="/static/js/core/StateManager.js"></script>
    <script src="/static/js/core/EventManager.js"></script>

    <!-- interaction modules -->
    <script src="/static/js/interactions/DragHandler.js"></script>
    <script src="/static/js/interactions/SelectionHandler.js"></script>
    <script src="/static/js/interactions/ConnectionHandler.js"></script>

    <!-- rendering modules -->
    <script src="/static/js/rendering/NodeRenderer.js"></script>
    <script src="/static/js/rendering/LinkRenderer.js"></script>
    <script src="/static/js/rendering/GroupRenderer.js"></script>
    <script src="/static/js/rendering/AnnotationRenderer.js"></script>

    <!-- sidebar components -->
    <script src="/static/js/components/sidebar/Sidebar.base.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.content.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.constants.js"></script>
    <script src="/static/js/components/sidebar/ui/Dropdowns.js"></script>
    <script src="/static/js/components/sidebar/ui/Visibility.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.execution.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.single.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.link.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.multi.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.group.js"></script>
    <script src="/static/js/components/sidebar/panels/Panel.annotation.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.status.js"></script>

    <script src="/static/js/components/sidebar/Sidebar.selection.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.nodes.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.forms.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.files.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.links.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.analysis.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.iflogic.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.flowcharts.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.url.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.events.js"></script>
    <script src="/static/js/components/sidebar/Sidebar.runview.js"></script>

    <!-- main application entrypoint (builder) -->
    <script src="/static/js/core/FlowchartBuilder.js"></script>
    <script src="/static/js/main.js"></script>
{% endblock %}

    <!-- context menu -->
    <div class="context_menu" id="context_menu">
        <div class="context_menu_item" id="edit_node">edit node</div>
        <div class="context_menu_item" id="delete_node">Delete Node</div>
    </div>

        <!-- properties sidebar -->
        <div class="properties_sidebar" id="properties_sidebar">

            <!-- pinned header for node type -->
            <div class="properties_header" id="properties_header">
                <div id="properties_header_text">NODE</div>
            </div>
            
            <!-- default state -->
            <div class="properties_content active" id="default_properties">
                <div class="sidebar_content">
                    <div style="text-align: center; padding: 40px 20px; color: var(--on-surface); opacity: 0.7; margin-top: -60px;">
                        <span class="material-icons" style="font-size: 48px; margin-bottom: 16px;">info</span>
                        <p>select nodes to view properties</p>
                        <p style="font-size: 0.8em; margin-top: 8px;">shift+click for multi-select</p>
                    </div>
                </div>
            </div>

        <!-- settings moved to full page; this legacy panel is removed -->

            <!-- single node properties -->
            <div class="properties_content" id="single_node_properties">
                <div class="sidebar_content">
                    <!-- input node: inputs section only -->
                    <div class="form_group" id="input_node_inputs_section" style="display: none; flex: 1;">
                        <label class="form_label">inputs</label>
                        <div id="input_node_inputs_list" style="flex: 1; display: flex; flex-direction: column; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <div id="input_node_inputs_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">hourglass_empty</span>
                                <p style="font-size: 0.8em;">analyzing inputs...</p>
                            </div>
                            <div id="input_node_inputs_content" style="display: none; flex: 1;"></div>
                            <div id="input_node_inputs_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">info</span>
                                <p style="font-size: 0.8em;">no inputs found</p>
                            </div>
                            <div id="input_node_inputs_error" style="display: none; text-align: center; padding: 20px; color: #f44336;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">error</span>
                                <p id="input_node_inputs_error_message" style="font-size: 0.8em;">failed to analyze inputs</p>
                            </div>
                        </div>
                    </div>

                    <div class="form_group">
                        <label class="form_label" for="node_name">node name</label>
                        <input type="text" id="node_name" class="form_input" placeholder="enter node name">
                    </div>
                    <div class="form_group">
                        <label class="form_label" for="python_file">python file</label>
                        <div class="dropdown_container" style="position: relative;">
                            <input type="text" id="python_file" class="form_input dropdown_input" placeholder="" readonly>
                            <span class="dropdown_arrow material-icons">folder_open</span>
                            <div id="python_file_status_block" style="position: absolute; left: 10px; right: 28px; top: 0; bottom: 0; display: flex; align-items: center; gap: 6px; pointer-events: none;">
                                <span id="python_file_status_icon" class="material-icons" style="font-size: 16px;">close</span>
                                <span id="python_file_status_text" style="font-size: 0.85rem; opacity: 0.9;">select python file</span>
                            </div>
                        </div>
                        <div id="python_file_path_block" class="data_save_value data_save_value_monospace" style="margin-top: 6px;"></div>
                    </div>

                    <!-- quick action to add an if node magnetised to this python node -->
                    <div class="form_group" id="python_quick_actions">
                        <button class="btn btn_primary" id="add_if_condition_btn" style="width: 100%;">
                            <span class="material-icons">alt_route</span>
                            <span class="btn_label">+ if condition</span>
                        </button>
                    </div>

                    <!-- data save node: variable selection (dropdown of python node returns) -->
                    <div class="form_group" id="data_save_variable_section" style="display: none;">
                        <label class="form_label" for="data_save_variable_dropdown">variable</label>
                        <select id="data_save_variable_dropdown" class="form_input">
                            <option value="" style="font-style: italic;">select a variable</option>
                        </select>
                        <div id="data_save_variable_help" style="font-size: 0.75rem; color: var(--on-surface); opacity: 0.7; margin-top: 6px;">
                            choose from the python node's returns (data out)
                        </div>
                        <div id="data_save_variable_error" style="display:none; color:#f44336; font-size: .8rem; margin-top: 6px;">failed to load variables</div>
                    </div>

                    <!-- data save node: name data removed -->

                    <div class="form_group" id="arguments_section" style="display: none; flex: 1;">
                        <label class="form_label">arguments (data in)</label>
                        <div id="arguments_list" style="flex: 1; display: flex; flex-direction: column; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <div id="arguments_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">hourglass_empty</span>
                                <p style="font-size: 0.8em;">analyzing function...</p>
                            </div>
                            <div id="arguments_content" style="display: none; flex: 1;">
                                <!-- arguments will be populated here -->
                            </div>
                            <div id="arguments_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">info</span>
                                <p style="font-size: 0.8em;">no arguments found</p>
                            </div>
                        </div>
                    </div>
                    <div class="form_group" id="returns_section" style="display: none; flex: 1;">
                        <label class="form_label">returns (data out)</label>
                        <div id="returns_list" style="flex: 1; display: flex; flex-direction: column; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <div id="returns_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">hourglass_empty</span>
                                <p style="font-size: 0.8em;">analyzing function...</p>
                            </div>
                            <div id="returns_content" style="display: none; flex: 1;">
                                <!-- returns will be populated here -->
                            </div>
                            <div id="returns_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">info</span>
                                <p style="font-size: 0.8em;">no return values found</p>
                            </div>
                        </div>
                    </div>

                    <!-- if node variables section -->
                    <div class="form_group" id="if_node_variables_section" style="display: none; flex: 1;">
                        <label class="form_label">available variables</label>
                        <div id="if_node_variables_list" style="flex: 1; display: flex; flex-direction: column; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <div id="if_node_variables_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">hourglass_empty</span>
                                <p style="font-size: 0.8em;">analyzing connected python nodes...</p>
                            </div>
                            <div id="if_node_variables_content" style="display: none; flex: 1;">
                                <!-- if node variables will be populated here -->
                            </div>
                            <div id="if_node_variables_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">info</span>
                                <p style="font-size: 0.8em;">no variables available</p>
                                <p style="font-size: 0.7em; margin-top: 4px;">connect to a python node to see available variables</p>
                            </div>
                            <div id="if_node_variables_error" style="display: none; text-align: center; padding: 20px; color: #f44336;">
                                <span class="material-icons" style="font-size: 16px; margin-bottom: 4px;">error</span>
                                <p id="if_node_variables_error_message" style="font-size: 0.8em;">failed to analyze variables</p>
                            </div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- annotation properties -->
            <div class="properties_content" id="annotation_properties">
                <div class="sidebar_content">
                    <div class="form_group" id="text_annotation_properties">
                        <div class="form_group">
                            <label class="form_label" for="annotation_text_input">text</label>
                            <input type="text" id="annotation_text_input" class="form_input" placeholder="enter text">
                        </div>
                        <div class="form_group">
                            <label class="form_label" for="annotation_font_size_input">font size</label>
                            <input type="number" min="8" max="72" step="1" id="annotation_font_size_input" class="form_input" placeholder="14">
                        </div>
                    </div>
                    <div class="form_group" id="arrow_annotation_properties" style="display: none;">
                        <div class="form_group">
                            <label class="form_label" for="annotation_stroke_width_input">stroke width</label>
                            <input type="number" min="1" max="10" step="1" id="annotation_stroke_width_input" class="form_input" placeholder="2">
                        </div>
                        <div class="form_group">
                            <label class="form_label" for="annotation_stroke_color_input">stroke color</label>
                            <input type="color" id="annotation_stroke_color_input" class="form_input" value="#ffffff">
                        </div>
                    </div>
                </div>
            </div>

            <!-- multi-select properties -->
            <div class="properties_content" id="multi_select_properties">
                <div class="sidebar_content">
                    <div class="form_group">
                        <label class="form_label">selected nodes</label>
                        <div id="selected_nodes_list" style="max-height: 200px; overflow-y: auto; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <!-- selected nodes will be listed here -->
                        </div>
                    </div>
                    <div class="form_group">
                        <button class="btn btn_primary" id="create_group_btn" style="width: 100%; margin-bottom: 8px;">
                            <span class="material-icons">group_work</span>
                            create group
                        </button>
                        <button class="btn btn_secondary" id="align_nodes_btn" style="width: 100%; margin-bottom: 8px;">
                            <span class="material-icons">align_horizontal_center</span>
                            align nodes
                        </button>

                    </div>
                </div>
            </div>

            <!-- link properties -->
            <div class="properties_content" id="link_properties">
                <div class="sidebar_content">
                    <div class="form_group">
                        <label class="form_label">connection</label>
                        <div style="background: var(--surface-variant); border-radius: 4px; padding: 12px; margin-bottom: 16px; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span id="link_source_name" style="font-weight: 500;">source node</span>
                                    <span id="link_source_file" style="font-size: 0.8em; opacity: 0.7; margin-top: 2px;">source_file.py</span>
                                </div>
                                <span class="material-icons" style="color: var(--primary-color);">arrow_downward</span>
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <span id="link_target_name" style="font-weight: 500;">target node</span>
                                    <span id="link_target_file" style="font-size: 0.8em; opacity: 0.7; margin-top: 2px;">target_file.py</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- if-to-python connection variables dropdown -->
                    <div class="form_group" id="if_connection_variables_section" style="display: none;">
                        <label class="form_label">create condition</label>
                        <div style="background: var(--surface-variant); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
                            <div id="if_variables_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">hourglass_empty</span>
                                <p>analyzing python node returns...</p>
                            </div>
                            <div id="if_variables_list" style="display: none;">
                                <label class="form_label" for="if_variables_dropdown" style="margin: 0 0 6px 0;">variable</label>
                                <div class="dropdown_container" style="width: 100%; margin-bottom: 8px;">
                                    <input type="text" id="if_variables_dropdown" class="form_input dropdown_input" placeholder="select a variable" readonly>
                                    <span class="dropdown_arrow material-icons">arrow_drop_down</span>
                                    <div class="dropdown_menu" id="if_variables_dropdown_menu"></div>
                                </div>
                                

                                <!-- condition builder for ifâ†’python connection -->
                                <div id="if_condition_builder" style="margin-top: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr; row-gap: 10px; align-items: start;">
                                        <div id="if_combiner_container">
                                            <label class="form_label" style="margin: 0 0 6px 0;">combiner</label>
                                            <select id="if_condition_combiner" class="form_input">
                                                <option value="and">and</option>
                                                <option value="or">or</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form_label" style="margin: 0 0 6px 0;">operator</label>
                                            <div class="dropdown_container">
                                                <input type="text" id="if_operator_dropdown" class="form_input dropdown_input" placeholder="select operator" readonly>
                                                <span class="dropdown_arrow material-icons">arrow_drop_down</span>
                                                <div class="dropdown_menu" id="if_operator_dropdown_menu"></div>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="form_label" style="margin: 0 0 6px 0;">compare to</label>
                                            <input id="if_compare_value_input" type="text" class="form_input" placeholder="enter value" />
                                        </div>
                                        <div style="display:flex; align-items:flex-end;">
                                            <button id="if_add_condition_btn" class="btn btn_primary" style="width: 100%;">
                                                <span class="material-icons" style="font-size: 18px;">add</span>
                                                add condition
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!-- end condition builder -->
                            </div>
                            <div id="if_variables_error" style="display: none; text-align: center; padding: 20px; color: #f44336;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">error</span>
                                <p id="if_variables_error_message">failed to analyze variables</p>
                            </div>
                            <div id="if_variables_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">info</span>
                                <p>no return variables available</p>
                                <p style="font-size: 0.8em; margin-top: 8px;">the python node may not return any data</p>
                            </div>
                        </div>
                    </div>

                    <!-- active if conditions section -->
                    <div class="form_group" id="if_active_conditions_section" style="display: none;">
                        <label class="form_label">active if conditions</label>
                        <div style="background: var(--surface-variant); border-radius: 4px; padding: 12px;">
                            <div id="active_if_conditions_list">
                                <!-- conditions will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="form_group">
                        <label class="form_label">shared variables</label>
                        <div id="shared_variables_container" style="max-height: 300px; overflow-y: auto;">
                            <div id="variables_loading" style="text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">hourglass_empty</span>
                                <p>analyzing variable dependencies...</p>
                            </div>
                            <div id="variables_list" style="display: none;">
                                <!-- variables will be populated here -->
                            </div>
                            <div id="variables_error" style="display: none; text-align: center; padding: 20px; color: #f44336;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">error</span>
                                <p id="variables_error_message">failed to analyze variables</p>
                            </div>
                            <div id="variables_empty" style="display: none; text-align: center; padding: 20px; color: var(--on-surface); opacity: 0.7;">
                                <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">info</span>
                                <p>no shared variables detected</p>
                                <p style="font-size: 0.8em; margin-top: 8px;">variables may be passed through function calls or imports</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form_group">
                        <button class="btn btn_secondary" id="refresh_variables_btn" style="width: 100%; margin-bottom: 8px;">
                            <span class="material-icons">refresh</span>
                            <span class="delete_button_text_inner">Refresh Analysis</span>
                        </button>

                    </div>
                </div>
            </div>

            <!-- group properties -->
            <div class="properties_content" id="group_properties">
                <div class="sidebar_content">
                    <div class="form_group">
                        <label class="form_label" for="group_name">group name</label>
                        <input type="text" id="group_name" class="form_input" placeholder="enter group name">
                    </div>
                    <div class="form_group">
                        <label class="form_label">group colour</label>
                        <div id="group_color_palette" class="color_palette"></div>
                    </div>
                    <div class="form_group">
                        <label class="form_label">group members</label>
                        <div id="group_members_list" style="max-height: 200px; overflow-y: auto; background: var(--surface-variant); border-radius: 4px; padding: 8px;">
                            <!-- group members will be listed here -->
                        </div>
                    </div>
                    <div class="form_group">
                        <button class="btn btn_secondary btn_danger_subtle" id="ungroup_nodes" style="width: 100%; margin-bottom: 8px;">
                            <span class="material-icons delete_button_icon_1">ungroup</span>
                            <span class="delete_button_text_inner">ungroup</span>
                        </button>

                    </div>
                </div>
            </div>

            <!-- run mode execution panel -->
            <div class="properties_content" id="run_execution_properties">
                <div class="sidebar_content">
                    <!-- 1. execution status -->
                    <div class="form_group">
                        <label class="form_label">execution status</label>
                        <div id="execution_status" style="background: var(--surface-variant); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons" style="color: var(--on-surface); opacity: 0.7;">info</span>
                                <span id="execution_status_text">ready to start execution</span>
                            </div>
                            <!-- execution time (integrated into status block) -->
                            <div id="execution_time_row" style="display:none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                                <div style="display:flex; align-items: center; gap: 8px;">
                                    <span class="material-icons" style="color: #4caf50; font-size: 18px;">schedule</span>
                                    <span id="execution_time_text">0ms</span>
                                    <div style="flex: 1;"></div>
                                    <span id="execution_timestamp" style="font-size: 0.8em; opacity: 0.7;">--:--:--</span>
                                </div>
                            </div>
                            <!-- failure info (shown only when run has failed and no node is selected) -->
                            <div id="execution_failure_info" style="display:none; margin-top:12px; background: #2a1a1a; border: 1px solid rgba(244,67,54,0.35); border-radius: 8px; padding: 12px;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:6px;">
                                    <span class="material-icons" style="color:#f44336;">error</span>
                                    <strong style="color:#f44336; text-transform: lowercase;">execution failed</strong>
                                </div>
                                <div id="failed_node_title" style="margin-bottom:6px;">node: -</div>
                                <div id="failed_node_path" style="font-family: monospace; opacity:0.85; background: rgba(255,255,255,0.08); padding: 8px; border-radius: 4px;">path: -</div>
                                <div id="failed_node_error" style="margin-top:8px; font-size:0.85em; color:#f28b82; white-space: pre-wrap;"></div>
                                <div style="margin-top:10px; text-align:right;">
                                    <button id="go_to_failed_node_btn" class="btn btn_secondary" style="text-transform: lowercase;">
                                        <span class="material-icons">center_focus_strong</span>
                                        go to node
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. node file info -->
                    <div class="form_group">
                        <label class="form_label">node file info</label>
                        <div id="node_file_info" style="background: var(--surface-variant); border-radius: 4px; padding: 0px; margin-bottom: 16px;">
                            <div id="node_file_content">
                                <p style="opacity: 0.7; text-align: center; padding: 20px;">select a node to view file details</p>
                            </div>
                        </div>
                    </div>

                    <!-- global execution progress for default/no selection -->
                    <div class="form_group" id="execution_progress_group">
                        <label class="form_label">progress</label>
                        <div id="execution_progress" style="background: var(--surface-variant); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="material-icons" style="color: var(--on-surface); opacity: 0.7;">timeline</span>
                                <span id="execution_progress_text">0 of 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 3. node input (arguments, inputs) -->
                    <div class="form_group">
                        <label class="form_label">node input (arguments, inputs)</label>
                        <div id="node_input_log" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; color: #90caf9; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap;">
                            <div id="node_input_content"></div>
                        </div>
                    </div>

                    <!-- 4. node output (returns) -->
                    <div class="form_group">
                        <label class="form_label">node output (returns)</label>
                        <div id="node_output_log" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; color: #ffa726; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap;">
                            <div id="node_output_content"></div>
                        </div>
                    </div>

                    <!-- 4.5 returns (data out) - detailed variables list for python nodes after execution -->
                    <div class="form_group" id="python_returns_group" style="display: none;">
                        <label class="form_label">returns (data out)</label>
                        <div id="python_returns_content" style="background: transparent; border-radius: 4px; padding: 0;"></div>
                    </div>

                    <!-- 5. console output -->
                    <div class="form_group">
                        <label class="form_label">console output</label>
                        <div id="console_output_log" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; color: var(--on-surface); border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap;"></div>
                    </div>

                    <!-- data save run-mode details (shown only when selecting a data_save node in run mode) -->
                    <div class="form_group" id="data_save_details_group" style="display: none;">
                        <label class="form_label">data save</label>
                        <div id="data_save_details_card" class="data_save_details_card">
                            <div class="data_save_details_grid">
                                <div class="data_save_field">
                                    <div class="data_save_label">node name</div>
                                    <div id="ds_node_name" class="data_save_value"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">python variable</div>
                                    <div id="ds_variable_name" class="data_save_value data_save_value_monospace"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">type</div>
                                    <div id="ds_variable_type" class="data_save_value data_save_value_monospace"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">value</div>
                                    <pre id="ds_variable_value" class="data_save_value_pre"></pre>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">history</div>
                                    <div id="ds_history_confirmation" class="data_save_history data_save_history_waiting">
                                        <span class="material-icons data_save_history_icon" id="ds_history_icon">hourglass_empty</span>
                                        <span id="ds_history_text">waiting to save...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="checker"></div>

            <!-- pinned footer actions -->
            <div class="properties_footer">
                <button class="btn btn_secondary btn_danger_subtle" id="sidebar_delete_btn" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_node_from_sidebar" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span class="btn_label">Delete Node</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_selected_nodes" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Selected</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_link_btn" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Link</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_group" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Group</span>
                </button>
            </div>
        </div>
    </div>

{% endblock %}

{% block modals %}
    {% include 'partials/modals/create_flowchart.html' %}

    <!-- select python file modal (popup explorer) -->
    <div class="modal_overlay" id="select_python_modal">
        <div class="modal_content">
            <div class="modal_header">
                <h2 class="modal_title">SELECT PYTHON FILE</h2>
                <button class="modal_close" id="fe_close_btn">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="form_group">
                <label class="form_label">browse under nodes/</label>
                <div class="mini_explorer">
                    <div class="mini_explorer_toolbar">
                        <button type="button" class="mini_btn" id="fe_up_btn"><span class="material-icons" style="font-size:16px">arrow_upward</span> Up</button>
                        <button type="button" class="mini_btn" id="fe_new_file_btn"><span class="material-icons" style="font-size:16px">note_add</span> Create Python File</button>
                        <button type="button" class="mini_btn" id="fe_new_folder_btn"><span class="material-icons" style="font-size:16px">create_new_folder</span> Create Folder</button>
                    </div>
                    <div class="mini_breadcrumb" id="fe_breadcrumb"></div>
                    <div class="form_group" id="fe_new_file_group" style="display:none; margin: 8px 0 8px 0; min-height: 110px; max-height: 110px;">
                        <label class="form_label" for="fe_new_file_input">script name</label>
                        <div class="input_with_suffix">
                            <input type="text" id="fe_new_file_input" class="form_input" placeholder="enter script name" maxlength="100">
                            <span class="input_suffix">.py</span>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button type="button" class="mini_btn" id="fe_create_file_confirm"><span class="material-icons" style="font-size:16px">check</span> create</button>
                            <button type="button" class="mini_btn" id="fe_create_file_cancel"><span class="material-icons" style="font-size:16px">close</span> cancel</button>
                        </div>
                    </div>
                    <div class="mini_list" id="fe_list" style="overflow-y: auto; margin-top:8px;"><div style="padding:10px; opacity:0.7;">loading...</div></div>
                </div>
            </div>
            <div class="modal_actions">
                <button class="btn_modal btn_modal_secondary" id="fe_cancel">cancel</button>
                <button class="btn_modal btn_modal_primary" id="fe_confirm">select</button>
            </div>
        </div>
    </div>

    <!-- massive change detection modal -->
    <div class="modal_overlay" id="massive_change_modal">
        <div class="modal_content">
            <div class="modal_header">
                <h2 class="modal_title">massive change detected</h2>
                <button class="modal_close" id="massive_change_close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="form_group">
                <div class="form_text_md">massive change detected, revert to backup?</div>
            </div>
            <div class="modal_actions">
                <button class="btn_modal btn_modal_primary" id="massive_change_yes">yes (revert to backup)</button>
                <button class="btn_modal btn_modal_secondary" id="massive_change_no">no (those changes were purposeful)</button>
            </div>
        </div>
    </div>

{% endblock %}