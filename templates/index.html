{% extends 'base/base.html' %}
{% block title %}FlowCraft{% endblock %}
{% block styles %}{% endblock %}
{% block main_content_class %}{% endblock %}
{% block content %}
            <!-- start button in top left -->
            <div class="start_button_container" id="start_button_container" style="display: none;">
                <div class="run_controls_group">
                    <div class="loading_wheel" id="execution_loading_wheel" style="display: none;"></div>
                    <button class="btn btn_primary" id="execute_start_btn">
                        <span class="material-icons">play_arrow</span>
                        Start
                    </button>
                    <button class="btn btn_secondary" id="execute_clear_btn" title="clear">
                        <span class="material-icons">brush</span>
                        Clear
                    </button>
                </div>
            </div>

            <!-- separate right sidebar toggle bar -->
            <div class="sidebar_toggle_container" id="sidebar_toggle_container" style="display: none;">
                <button class="btn btn_secondary" id="toggle_sidebar_btn" title="hide properties" data-action="toggle-sidebar">
                    <span class="material-icons">chevron_right</span>
                </button>
            </div>
            
            <!-- floating toolbars -->
            <div class="left_toolbars" id="left_toolbars">
                <div class="floating_toolbar" id="floating_toolbar">
                    <button class="toolbar_btn" id="group_select_btn" title="group select tool">
                        <span class="material-icons">select_all</span>
                    </button>
                    <button class="toolbar_btn" id="deselect_btn" title="deselect all">
                        <span class="material-icons">pan_tool</span>
                    </button>
                    <button class="toolbar_btn" id="reset_view_btn" title="reset view to first node">
                        <span class="material-icons">center_focus_strong</span>
                    </button>
                        <button class="toolbar_btn" id="track_toggle_btn" title="auto track active node">
                            <span class="material-icons">gps_fixed</span>
                        </button>
                </div>
                <div class="floating_toolbar_secondary" id="floating_toolbar_secondary">
                    <button class="toolbar_btn" id="error_toggle_btn" title="show error circles">
                        <span class="material-icons">priority_high</span>
                    </button>
                    <button class="toolbar_btn" id="flow_toggle_btn" title="show flow circles">
                        <span class="material-icons">device_hub</span>
                    </button>
                </div>
            </div>
            
            <!-- top toolbars container (build mode only content) -->
            <div class="top_toolbars" id="top_toolbars">
                <!-- annotation toolbar (icon-only) -->
                <div class="annotation_toolbar" id="annotation_toolbar" style="display:none;">
                    <button class="btn btn_secondary toolbar_icon_btn" id="add_text_btn" title="add text">
                        <span class="material-icons">title</span>
                    </button>
                    <button class="btn btn_secondary toolbar_icon_btn" id="add_arrow_btn" title="add arrow">
                        <span class="material-icons">arrow_forward</span>
                    </button>
                </div>

                <!-- build mode horizontal toolbar -->
            <div class="build_toolbar" id="build_toolbar" style="display:none;">
                    <div class="build_toolbar_items" id="build_toolbar_items">
                        <div style="width: 0px; height: 8px;"></div>
                        <button class="btn btn_secondary" id="python_node_btn" title="add python node">
                            <span class="material-icons">code</span>
                            Python
                        </button>
                        <button class="btn btn_secondary" id="if_condition_btn" title="add if condition">
                            <span class="material-icons">alt_route</span>
                            IF Condition
                        </button>
                        <button class="btn btn_secondary" id="ai_btn" title="ai">
                            <span class="material-icons">smart_toy</span>
                            AI
                        </button>
                    </div>
                    <button class="btn btn_primary build_toolbar_toggle" id="build_toolbar_toggle" title="add" data-action="toggle-build-toolbar">
                        <span class="material-icons">add</span>
                    </button>
                </div>
            </div>
            
            <div class="canvas_container">
                <svg id="flowchart_canvas">
                    <g id="zoom_group">
                        <!-- Placeholder for node order numbers -->
                        <text class="node_order" x="0" y="0" visibility="hidden">0</text>
                    </g>
                </svg>
            </div>

            {% include 'partials/run_feed.html' %}
        </div>
{% block scripts %}
    <!-- d3 for builder canvas -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- core modules -->
    <script src="/static/js/flowchart/StateManager.js"></script>
    <script src="/static/js/flowchart/events/Saving.js"></script>
    
    <!-- mode-based loading: only load modules in build and run modes -->
    <script>
        // prevent multiple executions
        if (window.__mode_loading_initialized) {
            // already initialized, skip
        } else {
            window.__mode_loading_initialized = true;
            
            // check if we're in build or run mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode') || 'build';
            const isFlowchartMode = mode === 'build' || mode === 'run';
        
        if (isFlowchartMode) {
            // load all modules sequentially to ensure proper dependency order
            const allModules = [
                // EventManager first
                '/static/js/flowchart/events/EventManager.js',
                
                // interaction modules
                '/static/js/flowchart/events/DragHandler.js',
                '/static/js/flowchart/events/SelectionHandler.js',
                '/static/js/flowchart/events/ConnectionHandler.js',
                '/static/js/flowchart/events/CanvasHandler.js',
                '/static/js/flowchart/toolbars/Toolbars.js',
                
                // rendering modules
                '/static/js/flowchart/rendering/Node.js',
                '/static/js/flowchart/rendering/Link.js',
                '/static/js/flowchart/rendering/Group.js',
                '/static/js/flowchart/rendering/Annotation.js',
                '/static/js/flowchart/toolbars/NodeOrder.js',
                '/static/js/flowchart/toolbars/ErrorCircles.js',
                
                // execution modules
                '/static/js/flowchart/execution/ExecutionStatus.js',
                '/static/js/flowchart/execution/ExecutionLogic.js',
                '/static/js/flowchart/execution/Feed.js',
                '/static/js/flowchart/execution/NodeStateManager.js',
                '/static/js/flowchart/execution/VariableManager.js',
                '/static/js/flowchart/execution/OutputManager.js',
                '/static/js/flowchart/execution/ResumeExecution.js',
                '/static/js/flowchart/execution/ViewportTracker.js'
            ];
            
            function loadAllModulesSequentially(modules, index = 0) {
                if (index >= modules.length) {
                    // all modules loaded, now load sidebar modules
                    loadScriptsSequentially(sidebarModules);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = modules[index];
                script.onload = () => {
                    loadAllModulesSequentially(modules, index + 1);
                };
                script.onerror = () => {
                    console.error('failed to load module:', modules[index]);
                    loadAllModulesSequentially(modules, index + 1);
                };
                document.head.appendChild(script);
            }
            
            // modules will be loaded sequentially starting with service modules
            
            // properties sidebar components
            const sidebarModules = [
                // New simplified system
                '/static/js/flowchart/sidebar/utils/SectionLoader.js',
                
                // Common sections
                '/static/js/flowchart/sidebar/sections/common/Header.js',
                '/static/js/flowchart/sidebar/sections/common/NodeName.js',
                '/static/js/flowchart/sidebar/sections/common/DeleteButton.js',
 
                // Function modules
                '/static/js/flowchart/sidebar/functions/Analysis.js',
                '/static/js/flowchart/sidebar/functions/FileManagement.js',

                
            ];
            // load sidebar modules with proper dependency handling
            function loadScriptsSequentially(scripts, index = 0) {
                if (index >= scripts.length) {
                    // all scripts loaded, start dependency check
                    waitForDependencies();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = scripts[index];
                script.onload = () => {
                    loadScriptsSequentially(scripts, index + 1);
                };
                script.onerror = () => {
                    console.error('failed to load script:', scripts[index]);
                    loadScriptsSequentially(scripts, index + 1);
                };
                document.head.appendChild(script);
            }
            
            // sidebar modules will be loaded by loadAllModulesSequentially
            
            // node creation and deletion services
            const serviceModules = [
                '/static/js/flowchart/events/NodeCreate.js',
                '/static/js/flowchart/events/NodeDelete.js'
            ];
            
            function loadServiceModules(modules, index = 0) {
                if (index >= modules.length) {
                    // all service modules loaded, start loading all modules
                    loadAllModulesSequentially(allModules);
                    return;
                }
                
                const script = document.createElement('script');
                script.src = modules[index];
                script.onload = () => {
                    loadServiceModules(modules, index + 1);
                };
                script.onerror = () => {
                    console.error('failed to load service module:', modules[index]);
                    loadServiceModules(modules, index + 1);
                };
                document.head.appendChild(script);
            }
            
            loadServiceModules(serviceModules);
            
            // wait for all dependencies to be loaded before initializing
            function waitForDependencies() {
                const requiredClasses = [
                    'StateManager', 
                    'Storage',
                    'Saving',
                    'DragHandler', 
                    'SelectionHandler', 
                    'ConnectionHandler',
                    'CanvasHandler',
                    'NodeRenderer',
                    'LinkRenderer',
                    'GroupRenderer',
                    'AnnotationRenderer',
                    'CreateNode',
                    'DeleteNode',
                    'ExecutionFeed',
                    'EventManager',
                    'Sidebar',
                    'Toolbars',
                    'StatusBar',
                    'ExecutionLogic',
                    'NodeStateManager',
                    'VariableManager',
                    'ResumeExecution',
                    'ExecutionStatus',
                    'OutputManager',
                    'ViewportTracker'
                ];

                const missing = requiredClasses.filter(className => !window[className]);
                
                if (missing.length > 0) {
                    console.log('waiting for dependencies:', missing);
                    setTimeout(waitForDependencies, 100);
                    return;
                }
                
                console.log('all dependencies loaded, initializing app...');
                
                // load Index.js directly
                const mainScript = document.createElement('script');
                mainScript.src = '/static/js/pages/Index.js';
                document.head.appendChild(mainScript);
            }

            // dependencies will be checked after scripts are loaded
        }
        }
    </script>

    <script type="module" src="/static/js/flowchart/sidebar/ContentManager.js"></script>


{% endblock %}

    <!-- context menu -->
    <div class="context_menu" id="context_menu">
        <div class="context_menu_item" id="edit_node">edit node</div>
        <div class="context_menu_item" id="delete_node">Delete Node</div>
    </div>

        <!-- simplified sidebar structure -->
        <div class="properties_sidebar" id="properties_sidebar">
            <div class="properties_header" id="properties_header">
                <div id="properties_header_text">NODE</div>
            </div>

            <!-- single content area for all node types -->
            <div class="properties_content" id="single_node_properties">
                <div class="sidebar_content">
                    <!-- content will be dynamically injected here -->
                </div>
            </div>
        </div>
                    </div>

                    <!-- global execution progress for default/no selection -->
                    <div class="form_group" id="execution_progress_group">
                        <label class="form_label">progress</label>
                        <div id="execution_progress" style="background: var(--surface-variant); border-radius: 4px; padding: 12px; margin-bottom: 16px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span class="material-icons" style="color: var(--on-surface); opacity: 0.7;">timeline</span>
                                <span id="execution_progress_text">0 of 0</span>
                            </div>
                        </div>
                    </div>

                    <!-- 3. node input (arguments, inputs) -->
                    <div class="form_group">
                        <label class="form_label">node input (arguments, inputs)</label>
                        <div id="node_input_log" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; color: #90caf9; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap;">
                            <div id="node_input_content"></div>
                        </div>
                    </div>

                    <!-- 4. node output (returns) -->
                    <div class="form_group">
                        <label class="form_label">node output (returns)</label>
                        <div id="node_output_log" style="max-height: 200px; overflow-y: auto; background: #1a1a1a; color: #ffa726; border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.8em; white-space: pre-wrap;">
                            <div id="node_output_content"></div>
                        </div>
                    </div>

                    <!-- 4.5 returns (data out) - detailed variables list for python nodes after execution -->
                    <div class="form_group" id="python_returns_group" style="display: none;">
                        <label class="form_label">returns (data out)</label>
                        <div id="python_returns_content" style="background: transparent; border-radius: 4px; padding: 0;"></div>
                    </div>

                    <!-- 5. console output -->
                    <div class="form_group">
                        <label class="form_label">console output</label>
                        <div id="console_output_log" style="max-height: 300px; overflow-y: auto; background: #1a1a1a; color: var(--on-surface); border-radius: 4px; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85rem; white-space: pre-wrap;"></div>
                    </div>

                    <!-- data save run-mode details (shown only when selecting a data_save node in run mode) -->
                    <div class="form_group" id="data_save_details_group" style="display: none;">
                        <label class="form_label">data save</label>
                        <div id="data_save_details_card" class="data_save_details_card">
                            <div class="data_save_details_grid">
                                <div class="data_save_field">
                                    <div class="data_save_label">node name</div>
                                    <div id="ds_node_name" class="data_save_value"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">python variable</div>
                                    <div id="ds_variable_name" class="data_save_value data_save_value_monospace"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">type</div>
                                    <div id="ds_variable_type" class="data_save_value data_save_value_monospace"></div>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">value</div>
                                    <pre id="ds_variable_value" class="data_save_value_pre"></pre>
                                </div>
                                <div class="data_save_field">
                                    <div class="data_save_label">history</div>
                                    <div id="ds_history_confirmation" class="data_save_history data_save_history_waiting">
                                        <span class="material-icons data_save_history_icon" id="ds_history_icon">hourglass_empty</span>
                                        <span id="ds_history_text">waiting to save...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="checker"></div>

            <!-- pinned footer actions -->
            <div class="properties_footer">
                <button class="btn btn_secondary btn_danger_subtle" id="sidebar_delete_btn" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_node_from_sidebar" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span class="btn_label">Delete Node</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_selected_nodes" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Selected</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_link_btn" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Link</span>
                </button>
                <button class="btn btn_secondary btn_danger_subtle" id="delete_group" style="display: none; text-transform: capitalize;">
                    <span class="material-icons">delete</span>
                    <span style="display: inline-block; margin-bottom: 2px;">Delete Group</span>
                </button>
            </div>
        </div>
    </div>

{% endblock %}

{% block modals %}
    {% include 'partials/modals/create_flowchart.html' %}

    <!-- select python file modal (popup explorer) -->
    <div class="modal_overlay" id="select_python_modal">
        <div class="modal_content">
            <div class="modal_header">
                <h2 class="modal_title">SELECT PYTHON FILE</h2>
                        <button class="modal_close" data-modal-close="select_python_modal">
          <span class="material-icons">close</span>
        </button>
            </div>
            <div class="form_group">
                <label class="form_label">browse under nodes/</label>
                <div class="mini_explorer">
                    <div class="mini_explorer_toolbar">
                        <button type="button" class="mini_btn" id="fe_up_btn"><span class="material-icons" style="font-size:16px">arrow_upward</span> Up</button>
                        <button type="button" class="mini_btn" id="fe_new_file_btn"><span class="material-icons" style="font-size:16px">note_add</span> Create Python File</button>
                        <button type="button" class="mini_btn" id="fe_new_folder_btn"><span class="material-icons" style="font-size:16px">create_new_folder</span> Create Folder</button>
                    </div>
                    <div class="mini_breadcrumb" id="fe_breadcrumb"></div>
                    <div class="form_group" id="fe_new_file_group" style="display:none; margin: 8px 0 8px 0; min-height: 110px; max-height: 110px;">
                        <label class="form_label" for="fe_new_file_input">script name</label>
                        <div class="input_with_suffix">
                            <input type="text" id="fe_new_file_input" class="form_input" placeholder="enter script name" maxlength="100">
                            <span class="input_suffix">.py</span>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button type="button" class="mini_btn" id="fe_create_file_confirm"><span class="material-icons" style="font-size:16px">check</span> create</button>
                            <button type="button" class="mini_btn" id="fe_create_file_cancel"><span class="material-icons" style="font-size:16px">close</span> cancel</button>
                        </div>
                    </div>
                    <div class="mini_list" id="fe_list" style="overflow-y: auto; margin-top:8px;"><div style="padding:10px; opacity:0.7;">loading...</div></div>
                </div>
            </div>
            <div class="modal_actions">
                <button class="btn_modal btn_modal_secondary" id="fe_cancel">cancel</button>
                <button class="btn_modal btn_modal_primary" id="fe_confirm">select</button>
            </div>
        </div>
    </div>

    <!-- massive change detection modal -->
    <div class="modal_overlay" id="massive_change_modal">
        <div class="modal_content">
            <div class="modal_header">
                <h2 class="modal_title">massive change detected</h2>
                        <button class="modal_close" data-modal-close="massive_change_modal">
          <span class="material-icons">close</span>
        </button>
            </div>
            <div class="form_group">
                <div class="form_text_md">massive change detected, revert to backup?</div>
            </div>
            <div class="modal_actions">
                <button class="btn_modal btn_modal_primary" id="massive_change_yes">yes (revert to backup)</button>
                <button class="btn_modal btn_modal_secondary" id="massive_change_no">no (those changes were purposeful)</button>
            </div>
        </div>
    </div>

{% endblock %}