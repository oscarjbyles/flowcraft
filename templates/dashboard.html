<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowCraft â€¢ Dashboard</title>
    {% include 'partials/head.html' %}
    <link rel="stylesheet" href="/static/css/pages/dashboard.css">
    <!-- existing styles remain last for full fidelity -->
    <link rel="stylesheet" href="/static/css/index.css">
    
    {% include 'base/foot.html' %}

    <script>
        // initialize nav and dashboard
        document.addEventListener('DOMContentLoaded', () => {
            try { if (window.Navigation && typeof window.Navigation.init === 'function') window.Navigation.init(null); } catch(_) {}
            // create a single url manager instance for this page and a helper to preserve context across links
            let urlMgr = null;
            try { urlMgr = new URLManager(); } catch(_) {}

            function with_flowchart(path){
                try {
                    if (urlMgr && typeof urlMgr.buildUrlPreserveContext === 'function') {
                        return urlMgr.buildUrlPreserveContext(path);
                    }
                } catch(_) {}
                const u = new URL(path, window.location.origin);
                const params = new URLSearchParams(window.location.search);
                // preserve mode if present; default to build
                const mode = params.get('mode') || 'build';
                if (!u.searchParams.get('mode')) u.searchParams.set('mode', mode);
                // preserve display flowchart param for dashboard/scripts/builder
                const display = params.get('flowchart');
                if (display && (u.pathname === '/' || u.pathname === '/dashboard' || u.pathname === '/scripts')) {
                    u.searchParams.set('flowchart', display);
                }
                // preserve filename for data matrix
                const filename = params.get('flowchart_name');
                if (filename && u.pathname === '/data') {
                    u.searchParams.set('flowchart_name', filename);
                }
                return u.pathname + (u.search ? u.search : '');
            }
            async function init_dashboard(){
                // compute flow context compatible with other pages
                const flow_display = urlMgr ? urlMgr.getFlowchartDisplayNamePreferred() : (new URLSearchParams(window.location.search)).get('flowchart') || 'default';
                const flow_filename = urlMgr ? urlMgr.getFlowchartFilenameFromURL() : ((new URLSearchParams(window.location.search)).get('flowchart_name') || (flow_display + '.json'));

                // dom refs
                const el_total_exec = document.getElementById('kpi_total_exec');
                const el_success_rate = document.getElementById('kpi_success_rate');
                const el_avg_time = document.getElementById('kpi_avg_time');
                const el_nodes_cov = document.getElementById('kpi_nodes_cov');
                const el_missing = document.getElementById('kpi_missing');
                const el_orphan = document.getElementById('kpi_orphan');
                const el_dist = document.getElementById('distribution_bars');
                const el_recent_body = document.getElementById('recent_tbody');
                const el_failure_block = document.getElementById('failure_block');
                const el_links_build = document.getElementById('link_build');
                const el_links_run = document.getElementById('link_run');
                const el_links_scripts = document.getElementById('link_scripts');
                const el_links_data = document.getElementById('link_data');
                const el_clear_history = document.getElementById('btn_clear_history');

                // wire quick links with preserved context
                if (el_links_build) el_links_build.onclick = () => window.location.href = with_flowchart('/');
                if (el_links_run) el_links_run.onclick = () => window.location.href = with_flowchart('/?mode=run');
                if (el_links_scripts) el_links_scripts.onclick = () => window.location.href = with_flowchart('/scripts');
                if (el_links_data) el_links_data.onclick = () => window.location.href = with_flowchart('/data');

                // fetch in parallel (history api removed; we rely on embedded executions in flow json)
                let flow_resp, files_resp, editors_resp;
                try {
                    [flow_resp, files_resp, editors_resp] = await Promise.all([
                        fetch(`/api/flowchart?name=${encodeURIComponent(flow_display)}`),
                        fetch('/api/python-files'),
                        fetch('/api/editors')
                    ]);
                } catch (e) {
                    // basic network failure handling
                }

                let flow = { nodes: [], links: [], executions: [] };
                let py_files = [];
                let editors = [];
                try { flow = await flow_resp.json(); } catch(_) {}
                try { const f = await files_resp.json(); if (f && f.status === 'success') py_files = f.files || []; } catch(_) {}
                try { const ed = await editors_resp.json(); if (ed && ed.status === 'success') editors = ed.editors || []; } catch(_) {}

                // always use compact execution summaries embedded in the flow json for dashboard kpis
                let history = [];
                try { history = Array.isArray(flow.executions) ? flow.executions : []; } catch(_) { history = []; }

                // compute coverage + unassigned/orphan
                const total_nodes = Array.isArray(flow.nodes) ? flow.nodes.length : 0;
                const nodes_with_files = (flow.nodes || []).filter(n => (n && typeof n.pythonFile === 'string' && n.pythonFile.trim() !== ''));
                const nodes_with_files_count = nodes_with_files.length;
                // python nodes without associated files
                const python_nodes_without_files = (flow.nodes || []).filter(n => n && n.type === 'python_file' && (!n.pythonFile || String(n.pythonFile).trim() === ''));
                // orphaned nodes: nodes that have no incoming or outgoing links (excluding utility nodes)
                const utility_types = new Set(['input_node', 'data_save']);
                const candidate_nodes = (flow.nodes || []).filter(n => n && !utility_types.has(n.type));
                const linked_node_ids = new Set();
                (flow.links || []).forEach(l => { if (l && l.source != null) linked_node_ids.add(l.source); if (l && l.target != null) linked_node_ids.add(l.target); });
                const orphaned_nodes = candidate_nodes.filter(n => !linked_node_ids.has(n.id));

                // quick stats
                const total_exec = history.length;
                const avg_success = total_exec > 0 ? (history.reduce((a, b) => a + (b.success_percentage || 0), 0) / total_exec) : 0;
                const avg_elapsed_ms = total_exec > 0 ? Math.round(history.reduce((a, b) => a + (b.elapsed_ms || 0), 0) / total_exec) : 0;
                const fmt_elapsed = (ms) => {
                    try { ms = parseInt(ms); } catch(_) { return '0.000s'; }
                    const s = ms / 1000.0;
                    return `${s.toFixed(3)}s`;
                };
                if (el_total_exec) el_total_exec.textContent = String(total_exec);
                if (el_success_rate) el_success_rate.textContent = `${avg_success.toFixed(1)}%`;
                if (el_avg_time) el_avg_time.textContent = fmt_elapsed(avg_elapsed_ms);
                if (el_nodes_cov) el_nodes_cov.textContent = `${nodes_with_files_count}/${total_nodes}`;
                if (el_missing) el_missing.textContent = String(python_nodes_without_files.length);
                if (el_orphan) el_orphan.textContent = String(orphaned_nodes.length);

                // default editor chooser (same behavior as settings page)
                const el_def_input = document.getElementById('default_editor_input');
                const el_def_dropdown = document.getElementById('default_editor_dropdown');
                if (el_def_input && el_def_dropdown) {
                    // load saved preference from localstorage
                    try {
                        const saved = localStorage.getItem('flowcraft_default_editor');
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            el_def_input.value = parsed.name || parsed.path || 'custom editor';
                            el_def_input.dataset.path = parsed.path || '';
                        }
                    } catch(_) {}

                    // render dropdown items
                    function renderEditorsDropdown(editorsList){
                        if (!Array.isArray(editorsList) || editorsList.length === 0) {
                            el_def_dropdown.innerHTML = '<div class="dropdown_no_results">no editors found</div>';
                            return;
                        }
                        el_def_dropdown.innerHTML = editorsList.map(ed => `
                            <div class="dropdown_item" data-name="${ed.name}" data-path="${ed.path}">
                                <div class="dropdown_item_content">
                                    <div class="dropdown_item_name">${ed.name}</div>
                                    <div class="dropdown_item_meta" style="opacity:.7; font-size:.75rem;">${ed.path}</div>
                                </div>
                            </div>
                        `).join('');
                        el_def_dropdown.querySelectorAll('.dropdown_item').forEach(item => {
                            item.addEventListener('click', () => {
                                const editor = { name: item.dataset.name, path: item.dataset.path };
                                el_def_input.value = editor.name;
                                el_def_input.dataset.path = editor.path || '';
                                localStorage.setItem('flowcraft_default_editor', JSON.stringify(editor));
                                el_def_dropdown.classList.remove('show');
                            });
                        });
                    }

                    if (Array.isArray(editors) && editors.length) {
                        renderEditorsDropdown(editors);
                    } else {
                        // fallback fetch if initial editors load failed
                        try {
                            const resp = await fetch('/api/editors');
                            const data = await resp.json();
                            if (data && data.status === 'success') renderEditorsDropdown(data.editors);
                            else el_def_dropdown.innerHTML = '<div class="dropdown_no_results">failed to detect editors</div>';
                        } catch(_) {
                            el_def_dropdown.innerHTML = '<div class="dropdown_no_results">error detecting editors</div>';
                        }
                    }

                    // open/close behavior
                    el_def_input.addEventListener('click', (e) => {
                        e.stopPropagation();
                        el_def_dropdown.classList.toggle('show');
                    });
                    document.addEventListener('click', (e) => {
                        const container = el_def_input.closest('.dropdown_container');
                        if (container && !container.contains(e.target)) {
                            el_def_dropdown.classList.remove('show');
                        }
                    });
                }

                // execution distribution (last 40 success %)
                if (el_dist) {
                    const recent = history.slice(0, 40);
                    if (!recent.length) {
                        el_dist.innerHTML = '<div class="muted">no executions yet</div>';
                        try { el_dist.classList.add('empty'); } catch(_) {}
                    } else {
                        el_dist.innerHTML = '';
                        try { el_dist.classList.remove('empty'); } catch(_) {}
                        recent.forEach((h, idx) => {
                            const pct = Math.max(0, Math.min(100, Number(h.success_percentage || 0)));
                            const bar = document.createElement('div');
                            bar.className = 'bar';
                            // color bars based on execution status
                            const status = (h.status || '').toLowerCase();
                            if (status === 'success') {
                                bar.style.background = 'linear-gradient(180deg, #66bb6a 0%, #2e7d32 100%)';
                            } else if (status === 'failed') {
                                bar.style.background = 'linear-gradient(180deg, #f44336 0%, #c62828 100%)';
                            } else if (status === 'stopped') {
                                bar.style.background = 'linear-gradient(180deg, #ff9800 0%, #e65100 100%)';
                            } else {
                                bar.style.background = 'linear-gradient(180deg, #9e9e9e 0%, #616161 100%)';
                            }
                            // scale bars to avoid overflow: cap at 85% of container height and add small baseline
                            const scaled = 5 + Math.round(pct * 0.8);
                            bar.style.height = `${scaled}%`;
                            const v = document.createElement('div'); v.className = 'bar_value'; v.textContent = `${pct}%`;
                            v.style.transform = 'translateY(-2px)';
                            const l = document.createElement('div'); l.className = 'bar_label'; l.textContent = String(idx + 1);
                            bar.appendChild(v); bar.appendChild(l);
                            el_dist.appendChild(bar);
                        });
                    }
                }

                // recent executions table
                if (el_recent_body) {
                    if (!history.length) {
                        el_recent_body.innerHTML = '<tr><td colspan="5" class="muted" style="text-align:center; padding:14px;">no executions yet</td></tr>';
                    } else {
                        const rows = history.slice(0, 5).map(item => {
                            const cls = item.status === 'success' ? 'status_success' : (item.status === 'failed' ? 'status_failed' : 'status_info');
                            const badge = `<span class="status_badge ${cls}"><span class="material-icons" style="font-size:16px;">${item.status==='success'?'check_circle':(item.status==='failed'?'error':'info')}</span>${item.status || 'unknown'}</span>`;
                            const nodes = `${item.successful_nodes || 0} / ${item.total_nodes || 0}`;
                            const elapsed = item.execution_time || '-';
                            const when = item.timestamp || '-';
                            const viewBtn = `<button class="mini_btn" data-id="${item.execution_id}"><span class="material-icons" style="font-size:16px;">visibility</span> View</button>`;
                            return `<tr>
                                <td>${badge}</td>
                                <td>${nodes}</td>
                                <td>${String(item.success_percentage ?? 0)}%</td>
                                <td>${elapsed}</td>
                                <td class="right">${viewBtn}</td>
                            </tr>`;
                        }).join('');
                        el_recent_body.innerHTML = rows;
                        el_recent_body.querySelectorAll('button[data-id]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const id = btn.getAttribute('data-id');
                                const u = new URL('/', window.location.origin);
                                if (flow_display && flow_display !== 'default') u.searchParams.set('flowchart', flow_display);
                                u.searchParams.set('mode', 'run');
                                u.searchParams.set('executionId', id);
                                window.location.href = u.pathname + '?' + u.searchParams.toString();
                            });
                        });
                    }
                }

                // failure spotlight
                if (el_failure_block) {
                    // find up to 3 most recent failed executions
                    const failures = (history || []).filter(h => (h.status || '').toLowerCase() === 'failed').slice(0, 3);
                    if (!failures.length) {
                        el_failure_block.innerHTML = '<div class="muted">no failures in recent executions</div>';
                    } else {
                        // build compact single-line rows for each failure
                        const rowsHtml = failures.map((item, idx) => {
                            const name = item.failed_node || 'unknown';
                            const errorMsg = item.error_snippet || '-';
                            const execId = item.execution_id;
                            const elapsed = item.execution_time || '-';
                            const progressPct = (typeof item.completed_percentage === 'number')
                                ? item.completed_percentage
                                : (item && typeof item.total_nodes === 'number' && item.total_nodes > 0
                                    ? Math.round(((item.completed_nodes || 0) / item.total_nodes) * 100)
                                    : 0);
                            return `
                                <div class="failure_row">
                                    <span class="material-icons" style="color:#f44336;">error</span>
                                    <div class="failure_name" style="border:1px solid var(--border-color); padding: 2px 6px; border-radius: 6px;">${name}</div>
                                    <div class="failure_meta" style="margin: 0 8px; opacity:.8;">${elapsed} â€¢ ${progressPct}%</div>
                                    <div class="failure_meta" style="flex:1; min-width:0; overflow:hidden; text-overflow: ellipsis; white-space: nowrap;">${errorMsg}</div>
                                    <div class="failure_spacer"></div>
                                    <button class="mini_btn" data-fail-btn="${String(execId)}"><span class="material-icons" style="font-size:16px;">visibility</span> View</button>
                                </div>`;
                        }).join('');
                        el_failure_block.innerHTML = `<div class="failure_rows">${rowsHtml}</div>`;
                        // wire up view buttons to open run with correct execution id
                        el_failure_block.querySelectorAll('button[data-fail-btn]').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const id = btn.getAttribute('data-fail-btn');
                                const u = new URL('/', window.location.origin);
                                if (flow_display && flow_display !== 'default') u.searchParams.set('flowchart', flow_display);
                                u.searchParams.set('mode', 'run');
                                u.searchParams.set('executionId', id);
                                window.location.href = u.pathname + '?' + u.searchParams.toString();
                            });
                        });
                    }
                }

                // clear history action
                if (el_clear_history) {
                    el_clear_history.onclick = async () => {
                        if (!confirm('clear all executions for this flowchart?')) return;
                        try {
                            const resp = await fetch('/api/history/clear', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ flowchart_name: flow_filename })
                            });
                            const j = await resp.json();
                            if (j && j.status === 'success') window.location.reload(); else alert(j.message || 'failed to clear history');
                        } catch(_){ alert('error clearing history'); }
                    };
                }
            }
            init_dashboard();
        });
    </script>
</head>
<body>
    <div class="app_container">
        {% include 'partials/navigation.html' %}
        <div class="main_content full_width">
            <div class="dashboard_container">

                <!-- quick stats grid -->
                <div class="dash_card">
                    <div class="dash_title">quick stats</div>
                    <div class="kpi_grid">
                        <div class="kpi_card">
                            <div class="kpi_title">executions</div>
                            <div class="kpi_value" id="kpi_total_exec">0</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">history</span> total runs</div>
                        </div>
                        <div class="kpi_card">
                            <div class="kpi_title">progress rate</div>
                            <div class="kpi_value" id="kpi_success_rate">0%</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">check_circle</span> average</div>
                        </div>
                        <div class="kpi_card">
                            <div class="kpi_title">average run time</div>
                            <div class="kpi_value" id="kpi_avg_time">0.000s</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">schedule</span> per execution</div>
                        </div>
                        <div class="kpi_card">
                            <div class="kpi_title">node coverage</div>
                            <div class="kpi_value" id="kpi_nodes_cov">0/0</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">device_hub</span> nodes with files</div>
                        </div>
                        <div class="kpi_card">
                            <div class="kpi_title">unassigned python nodes</div>
                            <div class="kpi_value" id="kpi_missing">0</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">warning</span> python nodes without files</div>
                        </div>
                        <div class="kpi_card">
                            <div class="kpi_title">orphaned nodes</div>
                            <div class="kpi_value" id="kpi_orphan">0</div>
                                <div class="kpi_sub"><span class="material-icons u_mr_4 u_icon_16">device_hub</span> nodes with no links</div>
                        </div>
                    </div>
                </div>

                <div class="dash_columns">
                    <div class="dash_col_left">
                        <!-- recent executions -->
                        <div class="dash_card">
                            <div class="dash_title">recent executions</div>
                            <div class="table_wrap">
                                <table class="table">
                                    <colgroup>
                                        <col style="width: calc((100% - 112px) / 4);">
                                        <col style="width: calc((100% - 112px) / 4);">
                                        <col style="width: calc((100% - 112px) / 4);">
                                        <col style="width: calc((100% - 112px) / 4);">
                                        <col style="width: 112px;">
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th>status</th>
                                            <th>nodes</th>
                                            <th>progress %</th>
                                            <th>elapsed</th>
                                            <th class="right">actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent_tbody">
                                        <tr><td colspan="5" class="muted" style="text-align:center; padding:14px;">loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- execution distribution -->
                        <div class="dash_card">
                            <div class="dash_title">execution progress history</div>
                            <div id="distribution_bars" class="chart_bar_row"></div>
                        </div>
                    </div>

                    <div class="dash_col_right">
                        <!-- quick actions -->
                        <div class="dash_card">
                            <div class="dash_title">quick actions</div>
                            <div class="btn_row">
                                <button id="link_build" class="mini_btn"><span class="material-icons" style="font-size:16px;">build</span> Build</button>
                                <button id="link_run" class="mini_btn"><span class="material-icons" style="font-size:16px;">play_arrow</span> Run</button>
                                <button id="link_scripts" class="mini_btn"><span class="material-icons" style="font-size:16px;">code</span> Scripts</button>
                                <button id="link_data" class="mini_btn"><span class="material-icons" style="font-size:16px;">table_chart</span> Data Matrix</button>
                                <div class="u_flex_grow_1"></div>
                                <button id="btn_clear_history" class="mini_btn mini_btn_danger"><span class="material-icons" style="font-size:16px;">delete</span> Clear History</button>
                            </div>
                        </div>

                        <!-- choose default editor -->
                        <div class="dash_card">
                            <div class="dash_title">choose default editor</div>
                            <div class="form_group">
                                <label class="form_label">default editor</label>
                                <div class="dropdown_container">
                                    <input type="text" id="default_editor_input" class="form_input dropdown_input" placeholder="detecting installed editors..." readonly>
                                    <span class="dropdown_arrow material-icons">arrow_drop_down</span>
                                    <div class="dropdown_menu" id="default_editor_dropdown">
                                        <div class="dropdown_loading">scanning editors...</div>
                                    </div>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--on-surface); opacity: 0.7; margin-top: 6px;">used when opening files from the app</div>
                            </div>
                        </div>

                        <!-- failure spotlight -->
                        <div class="dash_card">
                            <div class="dash_title">failure spotlight</div>
                            <div id="failure_block"></div>
                        </div>
                    </div>
                </div>

            </div>
            {% include 'partials/status_bar.html' %}
        </div>
    </div>
    {% include 'partials/modals/create_flowchart.html' %}
</body>
</html>


